# –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ–≥–æ –æ–±—Ö–æ–¥—É –¥–æ—á—ñ—Ä–Ω—ñ—Ö —Å—Ç–æ—Ä—ñ–Ω–æ–∫ —É WhitelistManager

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

WhitelistManager –Ω–µ –¥–æ–¥–∞–≤–∞–≤ –¥–æ—á—ñ—Ä–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –≤ `allowed_ids`:
- –û–±—Ä–æ–±–ª—è–≤ —Ç—ñ–ª—å–∫–∏ entry points –∑ whitelist
- –†–µ–∫—É—Ä—Å–∏–≤–Ω–∏–π –æ–±—Ö—ñ–¥ –Ω–µ –ø—Ä–∞—Ü—é–≤–∞–≤
- –î–æ—á—ñ—Ä–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –ø—Ä–æ–ø—É—Å–∫–∞–ª–∏—Å—å –ø—Ä–∏ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó

## üîç –ü—Ä–∏—á–∏–Ω–∞

**–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∞ –æ–±—Ä–æ–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç—É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤—ñ–¥ `ConfluenceClient.get_child_pages()`:**

```python
# ‚ùå –ë–£–õ–û (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
children = await confluence_client.get_child_pages(str(page_id))

for child in children:
    child_id = int(child.get("id"))  # child —Ü–µ str, –∞ –Ω–µ dict!
```

**–ü—Ä–æ–±–ª–µ–º–∞:** `get_child_pages()` –ø–æ–≤–µ—Ä—Ç–∞—î `list[str]` (—Ç—ñ–ª—å–∫–∏ ID), –∞ –Ω–µ `list[dict]`.

## ‚úÖ –†—ñ—à–µ–Ω–Ω—è

**–í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–∞—Ä—Å–∏–Ω–≥ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ:**

```python
# ‚úÖ –°–¢–ê–õ–û (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
children = await confluence_client.get_child_pages(str(page_id))

for child_id_str in children:
    child_id = int(child_id_str)  # –ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ str ‚Üí int
    children_ids.add(child_id)
    
    # –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –æ–±—Ö–æ–¥–∏–º–æ –¥–æ—á—ñ—Ä–Ω—ñ
    grandchildren = await self._get_all_children(child_id, confluence_client)
    children_ids.update(grandchildren)
```

## üìù –ó–º—ñ–Ω–∏

### 1. –§–∞–π–ª: `src/core/whitelist/whitelist_manager.py`

**–í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ –º–µ—Ç–æ–¥ `_get_all_children()`:**
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞ –æ–±—Ä–æ–±–∫–∞ `list[str]` –∑–∞–º—ñ—Å—Ç—å `list[dict]`
- –î–æ–¥–∞–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –¥–µ—Ä–µ–≤–∞
- –î–æ–¥–∞–Ω–æ –ø—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ –Ω–∞—â–∞–¥–∫—ñ–≤ –Ω–∞ –∫–æ–∂–Ω–æ–º—É —Ä—ñ–≤–Ω—ñ

**–ü–æ–∫—Ä–∞—â–µ–Ω–æ –º–µ—Ç–æ–¥ `get_allowed_ids()`:**
- –õ–æ–≥—É–≤–∞–Ω–Ω—è entry points –ø–µ—Ä–µ–¥ –æ–±—Ä–æ–±–∫–æ—é
- –î–µ—Ç–∞–ª—å–Ω–∏–π –≤–∏–≤—ñ–¥ –∑—ñ–±—Ä–∞–Ω–∏—Ö –¥–æ—á—ñ—Ä–Ω—ñ—Ö –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ entry point
- –õ–æ–≥—É–≤–∞–Ω–Ω—è —Ñ—ñ–Ω–∞–ª—å–Ω–æ–≥–æ —Å–ø–∏—Å–∫—É allowed_ids

### 2. –§–∞–π–ª: `tests/test_whitelist_manager.py`

**–í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ —ñ—Å–Ω—É—é—á—ñ —Ç–µ—Å—Ç–∏:**
- `test_get_allowed_ids_with_children` - –∑–º—ñ–Ω–µ–Ω–æ mock –Ω–∞ `list[str]`
- `test_recursive_children_collection` - –∑–º—ñ–Ω–µ–Ω–æ mock –Ω–∞ `list[str]`

**–î–æ–¥–∞–Ω–æ –Ω–æ–≤—ñ —Ç–µ—Å—Ç–∏:**
- `test_deep_nested_children` - –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≥–ª–∏–±–∏–Ω–∏ –≤–∫–ª–∞–¥–µ–Ω–æ—Å—Ç—ñ (5 —Ä—ñ–≤–Ω—ñ–≤)
- `test_multiple_branches` - –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫—ñ–ª—å–∫–æ—Ö –≥—ñ–ª–æ–∫ –¥–µ—Ä–µ–≤–∞

### 3. –§–∞–π–ª: `tests/test_tag_space_whitelist_integration.py`

**–û–Ω–æ–≤–ª–µ–Ω–æ —ñ—Å–Ω—É—é—á—ñ —Ç–µ—Å—Ç–∏:**
- `test_tag_space_whitelist_with_children` - –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ mock

**–î–æ–¥–∞–Ω–æ –Ω–æ–≤–∏–π —Ç–µ—Å—Ç:**
- `test_tag_space_processes_deep_subtree` - —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ–π–Ω–∏–π —Ç–µ—Å—Ç –≥–ª–∏–±–æ–∫–æ–≥–æ –¥–µ—Ä–µ–≤–∞

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è

```bash
pytest tests/test_whitelist_manager.py -v
```

**–î–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:**
- ‚ùå –†–µ–∫—É—Ä—Å—ñ—è –Ω–µ –ø—Ä–∞—Ü—é–≤–∞–ª–∞
- ‚ùå –û–±—Ä–æ–±–ª—è–≤ —Ç—ñ–ª—å–∫–∏ entry points

**–ü—ñ—Å–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:**
- ‚úÖ 18/18 —Ç–µ—Å—Ç—ñ–≤ –ø—Ä–æ—Ö–æ–¥—è—Ç—å
- ‚úÖ –†–µ–∫—É—Ä—Å—ñ—è –ø—Ä–∞—Ü—é—î –Ω–∞ –±—É–¥—å-—è–∫—É –≥–ª–∏–±–∏–Ω—É
- ‚úÖ –ö—ñ–ª—å–∫–∞ –≥—ñ–ª–æ–∫ –æ–±—Ä–æ–±–ª—è—é—Ç—å—Å—è –∫–æ—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –î–æ—á—ñ—Ä–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –¥–æ–¥–∞—é—Ç—å—Å—è –≤ allowed_ids

## üîç –ü—Ä–∏–∫–ª–∞–¥ —Ä–æ–±–æ—Ç–∏

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ whitelist:
```json
{
  "spaces": [
    {
      "space_key": "TEST",
      "pages": [
        {"id": 100, "name": "Root", "root": true}
      ]
    }
  ]
}
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–µ—Ä–µ–≤–∞ –≤ Confluence:
```
100 (Root)
‚îú‚îÄ‚îÄ 101
‚îÇ   ‚îú‚îÄ‚îÄ 111
‚îÇ   ‚îî‚îÄ‚îÄ 112
‚îî‚îÄ‚îÄ 102
    ‚îî‚îÄ‚îÄ 121
```

### –î–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:
```
allowed_ids = {100}  # ‚ùå –¢—ñ–ª—å–∫–∏ entry point
```

### –ü—ñ—Å–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:
```
allowed_ids = {100, 101, 102, 111, 112, 121}  # ‚úÖ –ü–æ–≤–Ω–µ –¥–µ—Ä–µ–≤–æ
```

## üìã –õ–æ–≥—É–≤–∞–Ω–Ω—è

**–î–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –ø—Ä–æ—Ü–µ—Å—É:**

```
[WhitelistManager] Entry points for TEST: [{'id': 100, 'name': 'Root', 'root': True}]
[WhitelistManager] Processing entry point: Root (id=100, root=True)
[WhitelistManager] Page 100 has 2 direct children: ['101', '102']
[WhitelistManager] Page 101 has 2 direct children: ['111', '112']
[WhitelistManager] Page 101 has 2 descendants
[WhitelistManager] Page 102 has 1 direct children: ['121']
[WhitelistManager] Page 102 has 1 descendants
[WhitelistManager] Entry 100 ‚Üí added 5 descendants. Total collected: {101, 102, 111, 112, 121}
[WhitelistManager] Final allowed_ids for TEST: 6 pages
```

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä—ñ—ó –ø—Ä–∏–π–º–∞–Ω–Ω—è

- ‚úÖ –î–æ—á—ñ—Ä–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –¥–æ–¥–∞—é—Ç—å—Å—è –≤ allowed_ids
- ‚úÖ –†–µ–∫—É—Ä—Å—ñ—è –ø—Ä–∞—Ü—é—î –Ω–∞ –±—É–¥—å-—è–∫—É –≥–ª–∏–±–∏–Ω—É
- ‚úÖ –õ–æ–≥—É–≤–∞–Ω–Ω—è –ø–æ–∫–∞–∑—É—î —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–µ—Ä–µ–≤–∞
- ‚úÖ –Æ–Ω—ñ—Ç-—Ç–µ—Å—Ç–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç—å (18/18)
- ‚úÖ –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ–π–Ω—ñ —Ç–µ—Å—Ç–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç—å
- ‚úÖ tag-space –æ–±—Ä–æ–±–ª—è—î whitelist + –ø—ñ–¥–¥–µ—Ä–µ–≤–∞
- ‚úÖ –ü–æ–≤–µ–¥—ñ–Ω–∫–∞ —É TEST/SAFE_TEST/PROD –Ω–µ –∑–º—ñ–Ω–µ–Ω–∞

## üéØ –í–ø–ª–∏–≤ –Ω–∞ tag-space

**–î–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:**
```
Whitelist: [100]
–ü—Ä–æ—Å—Ç—ñ—Ä: [100, 101, 102, 999]
–û–±—Ä–æ–±–ª—è—î—Ç—å—Å—è: [100]          ‚ùå –¢—ñ–ª—å–∫–∏ entry point
–ü—Ä–æ–ø—É—Å–∫–∞—î—Ç—å—Å—è: [101, 102, 999]
```

**–ü—ñ—Å–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:**
```
Whitelist: [100]
–ü—Ä–æ—Å—Ç—ñ—Ä: [100, 101, 102, 999]
–û–±—Ä–æ–±–ª—è—î—Ç—å—Å—è: [100, 101, 102]  ‚úÖ Entry point + –¥–æ—á—ñ—Ä–Ω—ñ
–ü—Ä–æ–ø—É—Å–∫–∞—î—Ç—å—Å—è: [999]
```

## üöÄ –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

–ù–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –∫–æ–¥ —è–∫–∏–π –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î WhitelistManager - –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∞—Ü—é—î:

```python
# –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è —Ç–∞–∫–∏–º —Å–∞–º–∏–º
manager = WhitelistManager()
allowed_ids = await manager.get_allowed_ids("TEST", confluence_client)

# –ê–ª–µ —Ç–µ–ø–µ—Ä allowed_ids –º—ñ—Å—Ç–∏—Ç—å –í–°–ï –¥–µ—Ä–µ–≤–æ
```

## üìö –î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è

- **–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:** `src/core/whitelist/whitelist_manager.py`
- **–¢–µ—Å—Ç–∏:** `tests/test_whitelist_manager.py`
- **–Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è:** `tests/test_tag_space_whitelist_integration.py`
