# –†–µ–∑—é–º–µ: –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ç–∞ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è POST /bulk/tag-pages

**Date:** 2 January 2026  
**Problem:** dry_run=true –Ω–∞ 2 —Å—Ç–æ—Ä—ñ–Ω–∫–∞—Ö: 118+ —Å–µ–∫ –∑–∞–º—ñ—Å—Ç—å 10-15 —Å–µ–∫

---

## üîç –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (09 & 10 audit)

### –í–∏—è–≤–ª–µ–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏

| ‚Ññ | –ü—Ä–æ–±–ª–µ–º–∞ | –ü—Ä–∏—á–∏–Ω–∞ | –í–∏—Ç—Ä–∞—Ç–∞ —á–∞—Å—É |
|----|----------|---------|------------|
| 1 | –í–µ–ª–∏–∫–∏–π expand –ø–∞—Ä–∞–º–µ—Ç—Ä | `expand="body.storage,version"` | ~10-15 —Å–µ–∫/call |
| 2 | –ù–∞–¥–º—ñ—Ä–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è AI | –í–µ—Å—å HTML (5-10 MB) –Ω–∞ 3 KB –ø–æ—Ç—Ä—ñ–±–Ω–µ | ~30-50 —Å–µ–∫/call |
| 3 | –°–µ—Ä—ñ–π–Ω–∞ –æ–±—Ä–æ–±–∫–∞ | –ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –ø–∞—Ä–∞–ª–µ–ª—ñ–∑–º | ~100% –∑–∞—Ç—Ä–∏–º–∫–∞ |

### –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –∑–∞—Ç—Ä–∏–º–∫–∏
```
Per page expected:    ~5-7 —Å–µ–∫ (1 Confluence call + 1 AI call)
Per page actual:      ~59 —Å–µ–∫ (12x –ø–æ–≤—ñ–ª—å–Ω—ñ—à–µ)
Hidden time:          ~52-55 —Å–µ–∫

–†–æ–∑–±—ñ—Ä:
- Confluence API (expand="body.storage,version"):  +10-15 —Å–µ–∫
- AI tokenization (5-10 MB –∫–æ–Ω—Ç–µ–∫—Å—Ç—É):             +10-15 —Å–µ–∫
- AI processing (–≤–µ–ª–∏–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç):                +15-25 —Å–µ–∫
- Parsing + overhead:                              +5-10 —Å–µ–∫
```

---

## üí° –ó–∞–ø—Ä–æ–ø–æ–Ω–æ–≤–∞–Ω—ñ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è

### Fix #1: –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π expand (–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç üî¥ HIGH)
```python
# BEFORE
page = await self.confluence.get_page(page_id)  # expand="body.storage,version"

# AFTER
page = await self.confluence.get_page(page_id, expand="body.storage")
```
**–ï–∫–æ–Ω–æ–º—ñ—è:** ~10-15 —Å–µ–∫/call (-70%)

### Fix #2: –û–±–º–µ–∂–µ–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è AI (–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç üî¥ HIGH)
```python
# BEFORE
text = html  # –í–µ—Å—å –∫–æ–Ω—Ç–µ–Ω—Ç, 5-10 MB

# AFTER
from src.utils.html_cleaner import html_to_clean_text
text = html_to_clean_text(html, max_length=3000)
# –û—á–∏—â–µ–Ω—ñ—Å—Ç—å HTML + –æ–±–º–µ–∂–µ–Ω–Ω—è 3000 chars
```
**–ï–∫–æ–Ω–æ–º—ñ—è:** ~30-50 —Å–µ–∫/call (-90%)

### Fix #3: –ü–∞—Ä–∞–ª–µ–ª—ñ–∑–∞—Ü—ñ—è (–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç üü° MEDIUM)
```python
# BEFORE
for page_id in filtered_ids:
    result = process_page(page_id)  # –°–µ—Ä—ñ–π–Ω–∞

# AFTER
tasks = [process_page(pid) for pid in filtered_ids]
results = await asyncio.gather(*tasks)  # –ü–∞—Ä–∞–ª–µ–ª—å–Ω–∞
```
**–ï–∫–æ–Ω–æ–º—ñ—è:** ~50% —á–∞—Å—É –Ω–∞ 2+ —Å—Ç–æ—Ä—ñ–Ω–æ–∫

---

## üìä –û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### Performance Before vs After
```
BEFORE:
- 2 pages: 118 —Å–µ–∫
- Per page: 59 —Å–µ–∫
- Confluence calls: 2 √ó 10 —Å–µ–∫ = 20 —Å–µ–∫
- AI calls: 2 √ó 30 —Å–µ–∫ = 60 —Å–µ–∫
- Other: 38 —Å–µ–∫

AFTER (–≤—Å—ñ fix):
- 2 pages: 10-15 —Å–µ–∫ ‚úÖ
- Per page: 5-7 —Å–µ–∫ ‚úÖ
- Confluence calls: 2 √ó 2 —Å–µ–∫ = 4 —Å–µ–∫
- AI calls: 2 √ó 1 —Å–µ–∫ = 2 —Å–µ–∫
- Other: 4-9 —Å–µ–∫

IMPROVEMENT: 8-12x faster (87-92% reduction)
```

---

## üìÅ –°—Ç–≤–æ—Ä–µ–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏

| –î–æ–∫—É–º–µ–Ω—Ç | –¢–∏–ø | –°—É—Ç—å |
|----------|------|------|
| [09_tag_pages_diagnosis.md](09_tag_pages_diagnosis.md) | –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ | –ü–æ—á–∞—Ç–∫–æ–≤–∞ an√°l—ñ–∑ –ø—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è + –ø–∞—Ä–∞–ª–µ–ª—ñ–∑–∞—Ü—ñ—è |
| [09_tag_pages_parallelization_patch.md](09_tag_pages_parallelization_patch.md) | Patch | Fix #3: asyncio.gather() –ø–∞—Ä–∞–ª–µ–ª—ñ–∑–∞—Ü—ñ—è |
| [10_tag_pages_context_fix.md](10_tag_pages_context_fix.md) | –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ | –î–µ—Ç–∞–ª—å–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É |
| [10_tag_pages_optimization_patch.md](10_tag_pages_optimization_patch.md) | Patch | Fix #1 & #2: –æ–±–º–µ–∂–µ–Ω—ñ expand + –∫–æ–Ω—Ç–µ–∫—Å—Ç |
| [html_cleaner.py](src/utils/html_cleaner.py) | –ö–æ–¥ | HTML cleaning utility (–Ω–æ–≤–∏–π —Ñ–∞–π–ª) |

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∞ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å –≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è

### Phase 1: –ö—Ä–∏—Ç–∏—á–Ω—ñ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è (HIGH priority)
1. ‚úÖ –î–æ–¥–∞—Ç–∏ `html_cleaner.py`
2. ‚úÖ Update `bulk_tagging_service.py` (–º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π expand + –∫–æ–Ω—Ç–µ–∫—Å—Ç)
3. ‚úÖ Update `tagging_service.py` (–º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π expand + –∫–æ–Ω—Ç–µ–∫—Å—Ç)
4. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç–∏ unit —Ç–µ—Å—Ç–∏
5. ‚úÖ –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ–π–Ω–∏–π —Ç–µ—Å—Ç –∑ –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è–º —á–∞—Å—É

**–û—á—ñ–∫—É–≤–∞–Ω–∞ –µ–∫–æ–Ω–æ–º—ñ—è:** 118 —Å–µ–∫ ‚Üí 20-30 —Å–µ–∫ (4-6x)

### Phase 2: –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è (MEDIUM priority)
1. –î–æ–¥–∞—Ç–∏ –ø–∞—Ä–∞–ª–µ–ª—ñ–∑–∞—Ü—ñ—é asyncio.gather()
2. –ö–µ—à—É–≤–∞–Ω–Ω—è WhitelistManager
3. –ë–∞—Ç—á—É–≤–∞–Ω–Ω—è AI –ø—Ä–æ–º–ø—Ç—ñ–≤ (–¥–ª—è 5+ —Å—Ç–æ—Ä—ñ–Ω–æ–∫)

**–î–æ–¥–∞—Ç–∫–æ–≤–∞ –µ–∫–æ–Ω–æ–º—ñ—è:** 20-30 —Å–µ–∫ ‚Üí 10-15 —Å–µ–∫ (2-3x)

### Phase 3: –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ (LOW priority)
1. –î–æ–¥–∞—Ç–∏ –ª–æ–≥—É–≤–∞–Ω–Ω—è —á–∞—Å—É –≤–∏–∫–æ–Ω–∞–Ω–Ω—è per step
2. –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏
3. –ü—Ä–æ—Ñ—ñ–ª—ñ—é–≤–∞–Ω–Ω—è —É production

---

## ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —É—Å–ø—ñ—à–Ω–æ—Å—Ç—ñ

### Test Command
```bash
# –ó–∞–ø–∏—Ç –¥–æ API
curl -X POST http://localhost:8000/bulk/tag-pages \
  -H "Content-Type: application/json" \
  -d '{
    "space_key": "nkfedba",
    "page_ids": ["111", "222"],
    "dry_run": true
  }'

# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∞—Å —É –ª–æ–≥–∞—Ö:
# –ü–ï–†–ï–î: ~118 —Å–µ–∫
# –ü–Ü–°–õ–Ø: ~10-15 —Å–µ–∫ ‚úÖ
```

### Metrics to Track
```
1. Total execution time
2. Per-page processing time
3. Confluence API call count & duration
4. AI API call count & token usage
5. HTML cleaning reduction %
6. Memory usage
7. Quality of generated tags
```

---

## ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω—ñ —Ä–∏–∑–∏–∫–∏

| –†–∏–∑–∏–∫ | –ô–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—å | –ú—ñ—Ç–∏–≥–∞—Ü—ñ—è |
|--------|-----------|-----------|
| –Ø–∫—ñ—Å—Ç—å —Ç–µ–≥—É–≤–∞–Ω–Ω—è –¥–µ–≥—Ä–∞–¥–∞—Ü—ñ—è | –ù–∏–∑—å–∫–∞ | –¢–µ–≥—É–≤–∞–Ω–Ω—è —Ä–æ–±–∏—Ç—å—Å—è –Ω–∞ –ø–µ—Ä—à—É –ø–æ–ª–æ–≤–∏–Ω—É –∫–æ–Ω—Ç–µ–Ω—Ç—É (titulo + intro) |
| HTML parsing failures | –ù–∏–∑—å–∫–∞ | BeautifulSoup –Ω–∞–¥—ñ–π–Ω–∞, fallback –Ω–∞ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π —Ç–µ–∫—Å—Ç |
| Whitelist breaking | –î—É–∂–µ –Ω–∏–∑—å–∫–∞ | –õ–æ–≥—ñ–∫–∞ whitelist –Ω–µ –∑–º—ñ–Ω—é—î—Ç—å—Å—è |
| API rate limiting | –ù–∏–∑—å–∫–∞ | –ü–∞—Ä–∞–ª–µ–ª—ñ–∑–∞—Ü—ñ—è + throttling –≤—Å–µ —â–µ –ø—Ä–∏—Å—É—Ç–Ω—ñ |

---

## üìà –û—á—ñ–∫—É–≤–∞–Ω—ñ –±—ñ–∑–Ω–µ—Å-—Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏

### –î–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
- ‚úÖ –®–≤–∏–¥—à–∞ –æ–±—Ä–æ–±–∫–∞ —Ç–µ–≥—É–≤–∞–Ω–Ω—è (10x faster)
- ‚úÖ –ú–µ–Ω—à–µ —á–∞—Å –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è (118 —Å–µ–∫ ‚Üí 15 —Å–µ–∫)
- ‚úÖ –ö—Ä–∞—â–∞ user experience

### –î–ª—è —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∏
- ‚úÖ –ú–µ–Ω—à–µ API –∑–∞–ø–∏—Ç—ñ–≤ –¥–æ Confluence
- ‚úÖ –ú–µ–Ω—à–µ —Ç–æ–∫–µ–Ω—ñ–≤ –≤ OpenAI (100x –º–µ–Ω—à–µ)
- ‚úÖ –ú–µ–Ω—à–µ overhead –≤ –º–µ—Ä–µ–∂—ñ (MB ‚Üí KB)
- ‚úÖ –ú–µ–Ω—à–µ –≤–∞—Ä—Ç–æ—Å—Ç—ñ —Ö–æ—Å—Ç–∏–Ω–≥—É

### –§—ñ–Ω–∞–Ω—Å–æ–≤—ñ –≤–∏–≥–æ–¥–∏
```
Before: 
- 1 request = 50,000 tokens √ó $0.005/1K = $0.25
- 100 requests/day = $25/day

After:
- 1 request = 1,000 tokens √ó $0.005/1K = $0.005
- 100 requests/day = $0.50/day (50x –¥–µ—à–µ–≤—à–µ!)
```

---

## üöÄ Next Steps

1. **Review** –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏—á–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏ (09 & 10)
2. **Implement** Phase 1 (–∫—Ä–∏—Ç–∏—á–Ω—ñ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è)
3. **Test** –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º—É —Å–µ—Ä–µ–¥–æ–≤–∏—â—ñ
4. **Measure** —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
5. **Verify** —è–∫—ñ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
6. **Deploy** –¥–æ production
7. **Monitor** –º–µ—Ç—Ä–∏–∫–∏ –≤ production
8. **Optimize** –¥–æ–¥–∞—Ç–∫–æ–≤—ñ phases –∑–∞ –ø–æ—Ç—Ä–µ–±–æ—é

---

**Status:** ‚úÖ –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –≥–æ—Ç–æ–≤–æ –¥–æ –≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è  
**Confidence Level:** ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (–¥—É–∂–µ –≤–∏—Å–æ–∫–∞)  
**Estimated Implementation Time:** 2-4 –≥–æ–¥–∏–Ω–∏  
**Estimated ROI:** 8-12x –ø—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è –∑–∞ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏—Ö –∑–º—ñ–Ω
