# –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è Tag-Space: –ö—Ä–æ–∫-–∑–∞-–ö—Ä–æ–∫–æ–º –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è

## –û–≥–ª—è–¥
–¶—è —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –æ–ø–∏—Å—É—î —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—é –º–æ–¥—É–ª—ñ–≤ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó –≤ —ñ—Å–Ω—É—é—á–∏–π –∫–æ–¥.

**–ß–∞—Å:** 30-60 —Ö–≤–∏–ª–∏–Ω  
**–°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å:** –°–µ—Ä–µ–¥–Ω—è  
**–†–∏–∑–∏–∫:** –ù–∏–∑—å–∫–∏–π (—É—Å—ñ –∑–º—ñ–Ω–∏ —ñ–∑–æ–ª—å–æ–≤–∞–Ω—ñ, –±–µ–∑ –≤–ª–æ–º–Ω–∏—Ö –∑–º—ñ–Ω)

---

## –ü–µ—Ä–µ–¥—É–º–æ–≤–∏
- ‚úÖ –£—Å—ñ –º–æ–¥—É–ª—ñ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó —Å—Ç–≤–æ—Ä–µ–Ω—ñ
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è –≥–æ—Ç–æ–≤–∞
- ‚úÖ Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π –≥–æ—Ç–æ–≤–∏–π

---

## –§–∞–∑–∞ 1: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –°–µ—Ä–µ–¥–æ–≤–∏—â–∞ (5 —Ö–≤)

### –ö—Ä–æ–∫ 1.1: –û–Ω–æ–≤–ª–µ–Ω–Ω—è `.env`

–î–æ–¥–∞–π—Ç–µ –¥–æ —Ñ–∞–π–ª—É `.env`:

```env
# Tag-Space –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è
TAG_SPACE_AI_CONCURRENCY=3
TAG_SPACE_MAX_AI_CONCURRENCY=10
TAG_SPACE_BATCH_SIZE=5
TAG_SPACE_CACHE_ENABLED=true
TAG_SPACE_CACHE_SIZE=1000
```

**–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞:**
```bash
python -c "import os; print(os.getenv('TAG_SPACE_AI_CONCURRENCY', '–Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'))"
# –ü–æ–≤–∏–Ω–Ω–æ –≤–∏–≤–µ—Å—Ç–∏: 3
```

---

## –§–∞–∑–∞ 2: –û–Ω–æ–≤–ª–µ–Ω–Ω—è AI Router (10 —Ö–≤)

### –ö—Ä–æ–∫ 2.1: –î–æ–¥–∞–Ω–Ω—è —ñ–º–ø–æ—Ä—Ç—ñ–≤

–§–∞–π–ª: `src/core/ai/router.py`

–ù–∞ –ø–æ—á–∞—Ç–∫—É —Ñ–∞–π–ª—É (–±—ñ–ª—è —Ä—è–¥–∫–∞ 10) –¥–æ–¥–∞–π—Ç–µ:

```python
import asyncio
from src.core.ai.concurrency_manager import get_concurrency_manager
```

### –ö—Ä–æ–∫ 2.2: –ó–∞–º—ñ–Ω–∞ –ª–æ–≥—ñ–∫–∏ –ø–æ–≤—Ç–æ—Ä—ñ–≤

–ó–Ω–∞–π–¥—ñ—Ç—å –º–µ—Ç–æ–¥ `generate()` (–±—ñ–ª—è —Ä—è–¥–∫–∞ 150) —Ç–∞ –æ–Ω–æ–≤—ñ—Ç—å:

**–î–û (–ø–æ—Ç–æ—á–Ω–∏–π –∫–æ–¥):**
```python
async def _invoke(client: AIProvider, name: str) -> AIResponse:
    model = getattr(client, "model_default", None)
    router_logger.info(f"[ROUTER] Selected provider={name} model={model}")
    return await log_ai_call(...)

# –û–¥–∏–Ω —Ä–∞–∑, –ø–æ—Ç—ñ–º –≤—ñ–¥—Å—Ç—É–ø
try:
    return await _invoke(client, provider_name)
except Exception as primary_exc:
    # –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–∏—Å—è –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω—É
```

**–ü–Ü–°–õ–Ø (–æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–π –∫–æ–¥):**
```python
async def _invoke(client: AIProvider, name: str) -> AIResponse:
    model = getattr(client, "model_default", None)
    router_logger.info(f"[ROUTER] Selected provider={name} model={model}")
    concurrency_mgr = get_concurrency_manager()
    
    return await log_ai_call(...)

# –ï–∫—Å–ø–æ–Ω–µ–Ω—Ü—ñ–∞–ª—å–Ω–∞ –∑–∞—Ç—Ä–∏–º–∫–∞ –¥–ª—è –ø–æ–≤—Ç–æ—Ä—ñ–≤
max_retries = 3
backoff_delays = [0.5, 1.0, 2.0]
concurrency_mgr = get_concurrency_manager()

for attempt in range(max_retries + 1):
    try:
        result = await concurrency_mgr.call_with_limit(
            _invoke(client, provider_name)
        )
        return result
    
    except Exception as primary_exc:
        error_str = str(primary_exc)
        is_rate_limit = "429" in error_str
        
        if is_rate_limit:
            concurrency_mgr.record_rate_limit_error()
            router_logger.warning("[429] –ó–º–µ–Ω—à–µ–Ω–Ω—è –æ–¥–Ω–æ—á–∞—Å–Ω–æ—Å—Ç—ñ —á–µ—Ä–µ–∑ –æ–±–º–µ–∂–µ–Ω–Ω—è")
        
        if attempt < max_retries:
            delay = backoff_delays[attempt]
            concurrency_mgr.record_retry()
            router_logger.info(
                f"[BACKOFF] –ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ {delay}s (—Å–ø—Ä–æ–±–∞ {attempt+1}/{max_retries})"
            )
            await asyncio.sleep(delay)
        else:
            # –õ–æ–≥—ñ–∫–∞ –≤—ñ–¥—Å—Ç—É–ø—É...
            if self._fallback and self._fallback != provider_name:
                concurrency_mgr.record_fallback()
            raise
```

**–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞:**
```bash
python -c "from src.core.ai.router import AIProviderRouter; print('‚úÖ Router —ñ–º–ø–æ—Ä—Ç–∏ OK')"
```

---

## –§–∞–∑–∞ 3: –û–Ω–æ–≤–ª–µ–Ω–Ω—è Tag-Space (15 —Ö–≤)

### –ö—Ä–æ–∫ 3.1: –î–æ–¥–∞–Ω–Ω—è —ñ–º–ø–æ—Ä—Ç—ñ–≤

–§–∞–π–ª: `src/services/bulk_tagging_service.py`

–î–æ —Å–µ–∫—Ü—ñ—ó —ñ–º–ø–æ—Ä—Ç—ñ–≤ (–±—ñ–ª—è —Ä—è–¥–∫–∞ 10) –¥–æ–¥–∞–π—Ç–µ:

```python
from src.services.optimized_tag_space import OptimizedTagSpacePipeline
from src.core.ai.concurrency_manager import get_concurrency_manager
```

### –ö—Ä–æ–∫ 3.2: –ó–∞–º—ñ–Ω–∞ —Ü–∏–∫–ª–∞ –æ–±—Ä–æ–±–∫–∏ —Å—Ç–æ—Ä—ñ–Ω–æ–∫

–ó–Ω–∞–π–¥—ñ—Ç—å –º–µ—Ç–æ–¥ `tag_space()` (–±—ñ–ª—è —Ä—è–¥–∫–∞ 520).

–®—É–∫–∞–π—Ç–µ —Ü–µ–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç:

```python
# –°–¢–ê–†–ò–ô: –Ü—Ç–µ—Ä–∞—Ü—ñ—è –ø–æ —Å—Ç–æ—Ä—ñ–Ω–∫–∞—Ö –æ–¥–Ω–∞ –∑–∞ –æ–¥–Ω–æ—é
for page_id in pages_to_process:
    try:
        page = await self.confluence.get_page(page_id)
        # ... –æ–±—Ä–æ–±–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É ...
        results.append(...)
    except Exception as e:
        # ... –æ–±—Ä–æ–±–∏—Ç–∏ –ø–æ–º–∏–ª–∫—É ...
```

–ó–∞–º—ñ–Ω—ñ—Ç—å –Ω–∞:

```python
# –ù–û–í–ò–ô: –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è OptimizedTagSpacePipeline
logger.info("[TagSpace] –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è OptimizedTagSpacePipeline")

optimized_pipeline = OptimizedTagSpacePipeline(
    self.confluence,
    self.agent
)

# Callback –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—É
def on_progress(processed, total):
    if task_id in TASK_PROGRESS:
        TASK_PROGRESS[task_id]["processed"] = processed
    logger.debug(f"[TagSpace] –ü—Ä–æ–≥—Ä–µ—Å: {processed}/{total}")

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∑—É–ø–∏–Ω–µ–Ω–Ω—è
def check_stop():
    return not ACTIVE_TASKS.get(task_id, True)

# –ó–∞–ø—É—Å–∫ –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–æ–≥–æ –∫–æ–Ω–≤–µ—î—Ä–∞
try:
    pipeline_result = await optimized_pipeline.process_space(
        page_ids=pages_to_process,
        task_id=task_id,
        on_progress=on_progress,
        check_stop=check_stop
    )
    
    results = pipeline_result["results"]
    processed_count = pipeline_result["processed"]
    error_count = pipeline_result["errors"]
    
    # –õ–æ–≥—É–≤–∞–Ω–Ω—è –º–µ—Ç—Ä–∏–∫ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó
    cache_stats = pipeline_result["cache_stats"]
    concurrency_metrics = pipeline_result["concurrency_metrics"]
    
    perf_logger = get_logger("tag_space_performance")
    perf_logger.info(
        f"[OPTIMIZATION_SUMMARY] "
        f"–û–±—Ä–æ–±–ª–µ–Ω–æ: {processed_count}/{len(pages_to_process)}, "
        f"–ü–æ–º–∏–ª–æ–∫: {error_count}, "
        f"–ü–æ–ø–∞–¥–∞–Ω–Ω—è –∫–µ—à–∞: {cache_stats['hit_rate']}, "
        f"–û–±–º–µ–∂–µ–Ω–Ω—è: {concurrency_metrics['rate_limit_errors']}, "
        f"–í—ñ–¥—Å—Ç—É–ø–∏: {concurrency_metrics['fallback_switches']}, "
        f"–í—Å—å–æ–≥–æ –≤–∏–∫–ª–∏–∫—ñ–≤ AI: {concurrency_metrics['total_ai_calls']}"
    )

except Exception as e:
    logger.error(f"[TagSpace] –ü–æ–º–∏–ª–∫–∞ –∫–æ–Ω–≤–µ—î—Ä–∞: {e}", exc_info=True)
    raise
```

### –ö—Ä–æ–∫ 3.3: –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ

–ó–Ω–∞–π–¥—ñ—Ç—å –¥–µ —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –≤—ñ–¥–ø–æ–≤—ñ–¥—å (–∫—ñ–Ω–µ—Ü—å –º–µ—Ç–æ–¥—É `tag_space()`):

```python
response = {
    "task_id": task_id,
    "total": len(page_ids),
    "processed": len(results),  # ‚Üê –û–Ω–æ–≤–∏—Ç–∏ —Ü–µ
    "success": sum(1 for r in results if r.get("status") != "error"),
    "errors": sum(1 for r in results if r.get("status") == "error"),
    "skipped_by_whitelist": 0,  # ‚Üê –î–ª—è tag_space = 0
    "dry_run": effective_dry_run,
    "mode": mode,
    "whitelist_enabled": False,  # ‚Üê tag_space –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î whitelist
    "details": results
}
```

**–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞:**
```bash
python -c "from src.services.bulk_tagging_service import BulkTaggingService; print('‚úÖ Service —ñ–º–ø–æ—Ä—Ç–∏ OK')"
```

---

## –§–∞–∑–∞ 4: –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è (20 —Ö–≤)

### –ö—Ä–æ–∫ 4.1: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–∫—Ä–∏–ø—Ç—É

–§–∞–π–ª: `test_optimization.py`

```python
#!/usr/bin/env python3
"""–®–≤–∏–¥–∫–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –º–æ–¥—É–ª—ñ–≤ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó."""

import asyncio
from src.core.ai.concurrency_manager import get_concurrency_manager
from src.core.ai.caching_layer import get_ai_cache, get_batch_processor


async def test_concurrency():
    """–¢–µ—Å—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –æ–¥–Ω–æ—á–∞—Å–Ω–æ—Å—Ç—ñ."""
    print("\n[TEST] –ú–µ–Ω–µ–¥–∂–µ—Ä –æ–¥–Ω–æ—á–∞—Å–Ω–æ—Å—Ç—ñ...")
    mgr = get_concurrency_manager()
    
    # –ü–µ—Ä–µ–≤—ñ—Ä–∞ –ø–æ—á–∞—Ç–∫–æ–≤–æ–≥–æ —Å—Ç–∞–Ω—É
    assert mgr.current_concurrency > 0, "–û–¥–Ω–æ—á–∞—Å–Ω—ñ—Å—Ç—å –ø–æ–≤–∏–Ω–Ω–∞ –±—É—Ç–∏ > 0"
    print(f"  ‚úÖ –ü–æ—á–∞—Ç–∫–æ–≤–∞ –æ–¥–Ω–æ—á–∞—Å–Ω—ñ—Å—Ç—å: {mgr.current_concurrency}")
    
    # –¢–µ—Å—Ç –æ–±—Ä–æ–±–∫–∏ –æ–±–º–µ–∂–µ–Ω–Ω—è
    mgr.record_rate_limit_error()
    assert mgr.metrics["rate_limit_errors"] == 1
    print(f"  ‚úÖ –ó–∞–ø–∏—Å –æ–±–º–µ–∂–µ–Ω–Ω—è –ø—Ä–∞—Ü—é—î")
    
    # –¢–µ—Å—Ç –º–µ—Ç—Ä–∏–∫
    metrics = mgr.get_metrics()
    assert "total_ai_calls" in metrics
    print(f"  ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ: {list(metrics.keys())}")


def test_cache():
    """–¢–µ—Å—Ç –∫–µ—à–∏—Ä—É–≤–∞–Ω–Ω—è."""
    print("\n[TEST] –®–∞—Ä –∫–µ—à—É–≤–∞–Ω–Ω—è...")
    cache = get_ai_cache()
    
    # –¢–µ—Å—Ç set/get
    page_id = "test_123"
    content = "—Ç–µ—Å—Ç–æ–≤–∏–π –≤–º—ñ—Å—Ç –¥–ª—è –∫–µ—à—É–≤–∞–Ω–Ω—è"
    result = {"tags": ["tag1", "tag2"]}
    
    cached = cache.get(page_id, content)
    assert cached is None, "–ö–µ—à –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ–π —Å–ø–æ—á–∞—Ç–∫—É"
    print(f"  ‚úÖ –ü–æ—Ä–æ–∂–Ω—ñ–π –∫–µ—à –ø–æ–≤–µ—Ä—Ç–∞—î None")
    
    cache.set(page_id, content, result, version=1)
    cached = cache.get(page_id, content, version=1)
    assert cached == result, "–ö–µ—à –ø–æ–≤–∏–Ω–µ–Ω –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç"
    print(f"  ‚úÖ –ó–∞–ø–∏—Å/—á–∏—Ç–∞–Ω–Ω—è –∫–µ—à–∞ –ø—Ä–∞—Ü—é—î")
    
    # –¢–µ—Å—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    stats = cache.get_stats()
    assert stats["hits"] >= 1
    print(f"  ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–µ—à–∞: {stats}")


def test_batch():
    """–¢–µ—Å—Ç –±–∞—Ç—á—É–≤–∞–Ω–Ω—è."""
    print("\n[TEST] –ë–∞—Ç—á–µ—Ä...")
    processor = get_batch_processor()
    
    # –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ç–µ—Å—Ç–æ–≤—ñ –¥–∞–Ω—ñ
    pages = [
        {"page_id": f"page_{i}", "content": f"content_{i}"}
        for i in range(15)
    ]
    
    batches = processor.create_batches(pages)
    assert len(batches) == 3, "15 —Å—Ç–æ—Ä—ñ–Ω–æ–∫ –∑ batch_size=5 –ø–æ–≤–∏–Ω–Ω—ñ —Å—Ç–≤–æ—Ä–∏—Ç–∏ 3 –≥—Ä—É–ø–∏"
    print(f"  ‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ {len(batches)} –≥—Ä—É–ø")
    
    # –¢–µ—Å—Ç —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è
    prompt = processor.format_batch_for_ai(batches[0])
    assert "page_0" in prompt
    print(f"  ‚úÖ –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –≥—Ä—É–ø–∏ –ø—Ä–∞—Ü—é—î (–¥–æ–≤–∂–∏–Ω–∞: {len(prompt)})")


async def main():
    """–ó–∞–ø—É—Å—Ç–∏—Ç–∏ —É—Å—ñ —Ç–µ—Å—Ç–∏."""
    print("=" * 60)
    print("–í–ê–õ–Ü–î–ê–¶–Ü–Ø –û–ü–¢–ò–ú–Ü–ó–ê–¶–Ü–á TAG-SPACE")
    print("=" * 60)
    
    try:
        await test_concurrency()
        test_cache()
        test_batch()
        
        print("\n" + "=" * 60)
        print("‚úÖ –í–°–Ü –¢–ï–°–¢–ò –ü–†–û–ô–î–ï–ù–Ü!")
        print("=" * 60)
        print("\n–ì–æ—Ç–æ–≤–æ –¥–æ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó!")
        
    except AssertionError as e:
        print(f"\n‚ùå –¢–ï–°–¢ –ù–ï –ü–†–û–ô–®–û–í: {e}")
        return 1
    except Exception as e:
        print(f"\n‚ùå –ü–û–ú–ò–õ–ö–ê: {e}")
        import traceback
        traceback.print_exc()
        return 1
    
    return 0


if __name__ == "__main__":
    exit(asyncio.run(main()))
```

**–ó–∞–ø—É—Å—Ç—ñ—Ç—å —Ü–µ:**
```bash
python test_optimization.py
# –ü–æ–≤–∏–Ω–Ω–æ –≤–∏–≤–µ—Å—Ç–∏:
# ‚úÖ –í–°–Ü –¢–ï–°–¢–ò –ü–†–û–ô–î–ï–ù–Ü!
```

### –ö—Ä–æ–∫ 4.2: –¢–µ—Å—Ç –∑ —Ä–µ–∞–ª—å–Ω–∏–º tag-space

–ó–∞–ø—É—Å—Ç—ñ—Ç—å —Å–µ—Ä–≤–µ—Ä:
```bash
uvicorn src.main:app --reload
```

–í —ñ–Ω—à–æ–º—É —Ç–µ—Ä–º—ñ–Ω–∞–ª—ñ:
```bash
curl -X POST "http://localhost:8000/bulk/tag-space/nkfedba" \
  -H "Content-Type: application/json" \
  -d '{"dry_run": true}'
```

**–ü–æ–≤–∏–Ω–Ω–∞ –±—É—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å:**
```json
{
  "task_id": "...",
  "total": 46,
  "processed": 46,  # ‚Üê –£—Å—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏!
  "success": 40,
  "errors": 0,
  "skipped_by_whitelist": 0,  # ‚Üê –ó–∞–≤–∂–¥–∏ 0 –¥–ª—è tag_space!
  ...
}
```

---

## –§–∞–∑–∞ 5: –í–∞–ª—ñ–¥–∞—Ü—ñ—è (10 —Ö–≤)

### –ö—Ä–æ–∫ 5.1: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ª–æ–≥—ñ–≤

```bash
# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∞–¥–∞–ø—Ç–∏–≤–Ω—É –æ–¥–Ω–æ—á–∞—Å–Ω—ñ—Å—Ç—å
tail -100 logs/ai_router.log | grep -i "throttle\|429\|backoff"
# –ü–æ–≤–∏–Ω–Ω–æ –ø–æ–∫–∞–∑–∞—Ç–∏ –∞–¥–∞–ø—Ç–∏–≤–Ω—ñ –∫–æ—Ä–∏–≥—É–≤–∞–Ω–Ω—è –æ–¥–Ω–æ—á–∞—Å–Ω–æ—Å—Ç—ñ

# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∫–µ—à—É–≤–∞–Ω–Ω—è
tail -100 logs/app.log | grep -i "cache"
# –ü–æ–≤–∏–Ω–Ω–æ –ø–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–ø–∞–¥–∞–Ω–Ω—è –∫–µ—à–∞ –Ω–∞ 2-–º—É –∑–∞–ø—É—Å–∫—É

# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∑–∞–≥–∞–ª—å–Ω—É –µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å
grep "OPTIMIZATION_SUMMARY" logs/app.log
# –ü–æ–≤–∏–Ω–Ω–æ –ø–æ–∫–∞–∑–∞—Ç–∏ –º–µ—Ç—Ä–∏–∫–∏ –Ω–∞ –∫–æ–∂–Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è tag-space
```

### –ö—Ä–æ–∫ 5.2: –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫

–°–∫—Ä–∏–ø—Ç –¥–ª—è –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É (Linux/Mac):
```bash
#!/bin/bash
# monitor_optimization.sh

echo "–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó..."
while true; do
  clear
  echo "=== –°–¢–ê–¢–£–° –û–ü–¢–ò–ú–Ü–ó–ê–¶–Ü–á TAG-SPACE ==="
  echo ""
  echo "–ü–æ–º–∏–ª–∫–∏ –æ–±–º–µ–∂–µ–Ω–Ω—è (429):"
  grep "429\|THROTTLE" logs/ai_router.log | tail -5
  echo ""
  echo "–í—ñ–¥—Å—Ç—É–ø–∏ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞:"
  grep "FALLBACK" logs/ai_router.log | tail -5
  echo ""
  echo "–ù–∞–π–Ω–æ–≤—ñ—à–µ —Ä–µ–∑—é–º–µ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó:"
  grep "OPTIMIZATION_SUMMARY" logs/app.log | tail -1
  echo ""
  sleep 5
done
```

---

## –§–∞–∑–∞ 6: –ß–µ–∫-–ª–∏—Å—Ç –ü–µ—Ä–µ–¥ –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è–º

–ü–µ—Ä–µ–¥ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω—è–º —É –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ:

- [ ] –£—Å—ñ –º–æ–¥—É–ª—ñ —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω—ñ –±–µ–∑ –ø–æ–º–∏–ª–æ–∫
- [ ] –ó–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ –≤ `.env`
- [ ] –¢–µ—Å—Ç–æ–≤–∏–π —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç—å (`test_optimization.py`)
- [ ] –ú–∞–ª–∞ –±–∞–∑–∞ –æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è –±–µ–∑ –ø–æ–º–∏–ª–æ–∫ (< 30 —Å–µ–∫)
- [ ] –ü–æ–ø–∞–¥–∞–Ω–Ω—è –∫–µ—à–∞ > 50% –Ω–∞ 2-–º—É –∑–∞–ø—É—Å–∫—É
- [ ] –õ–æ–≥–∏ –ø–æ–∫–∞–∑—É—é—Ç—å –æ—á—ñ–∫—É–≤–∞–Ω—ñ –º–µ—Ç—Ä–∏–∫–∏
- [ ] –ü–ª–∞–Ω –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –≥–æ—Ç–æ–≤–∏–π (–¥–∏–≤. –Ω–∏–∂—á–µ)

---

## –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è (–Ø–∫—â–æ –©–æ—Å—å –ù–µ –¢–∞–∫)

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–∏–π –†–µ–∂–∏–º

–†–µ–¥–∞–≥—É–π—Ç–µ `.env`:
```env
TAG_SPACE_AI_CONCURRENCY=1
TAG_SPACE_BATCH_SIZE=1
TAG_SPACE_CACHE_ENABLED=false
```

–ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Å–µ—Ä–≤–µ—Ä. –¶–µ –≤–∏–º–∫–Ω–µ —É—Å—ñ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó.

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü–æ–≤–Ω–µ –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è

–ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –∫–æ–¥–∏ –∑–º—ñ–Ω:
```bash
git diff src/core/ai/router.py  # –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —â–æ –∑–º—ñ–Ω–∏–ª–æ—Å—è
git checkout src/core/ai/router.py  # –ü–æ–≤–µ—Ä–Ω—É—Ç–∏
git checkout src/services/bulk_tagging_service.py
```

–ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –∑ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–º –∫–æ–¥–æ–º.

---

## –û—á—ñ–∫—É–≤–∞–Ω—ñ –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ü—ñ—Å–ª—è –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó

### –ú–∞–ª–∞ –±–∞–∑–∞ (10 —Å—Ç–æ—Ä—ñ–Ω–æ–∫)
- ‚úÖ –ß–∞—Å: < 30 —Å–µ–∫—É–Ω–¥
- ‚úÖ –í–∏–∫–ª–∏–∫—ñ–≤ AI: ~2-4
- ‚úÖ –ü–æ–ø–∞–¥–∞–Ω—å –∫–µ—à–∞ (2-–π –∑–∞–ø—É—Å–∫): > 70%
- ‚úÖ –ü–æ–º–∏–ª–æ–∫ 429: 0

### –°–µ—Ä–µ–¥–Ω—è –±–∞–∑–∞ (100 —Å—Ç–æ—Ä—ñ–Ω–æ–∫)
- ‚úÖ –ß–∞—Å: 1-2 —Ö–≤–∏–ª–∏–Ω–∏
- ‚úÖ –í–∏–∫–ª–∏–∫—ñ–≤ AI: ~20-40 (–ø—Ä–æ—Ç–∏ 100-200)
- ‚úÖ –ü–æ–º–∏–ª–æ–∫ 429: < 3 (–ø—Ä–æ—Ç–∏ 15-20)
- ‚úÖ –í—ñ–¥—Å—Ç—É–ø—ñ–≤ –Ω–∞ GPT: 0 (–ø—Ä–æ—Ç–∏ 10-15)

### –í–µ–ª–∏–∫–∞ –±–∞–∑–∞ (500+ —Å—Ç–æ—Ä—ñ–Ω–æ–∫)
- ‚úÖ –ß–∞—Å: 5-10 —Ö–≤–∏–ª–∏–Ω
- ‚úÖ –í–∏–∫–ª–∏–∫—ñ–≤ AI: ~100-150 (—Å–∫–æ—Ä–æ—á–µ–Ω–Ω—è –≤ 5-10 —Ä–∞–∑—ñ–≤)
- ‚úÖ –û–¥–Ω–æ—á–∞—Å–Ω—ñ—Å—Ç—å: 3-4 (–∞–≤—Ç–æ—Ç—é–Ω–æ–≤–∞–Ω–∞)
- ‚úÖ –ü–æ–ø–∞–¥–∞–Ω—å –∫–µ—à–∞: 60-80%

---

## –ù–∞—Å—Ç—É–ø–Ω—ñ –ö—Ä–æ–∫–∏ –ü—ñ—Å–ª—è –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó

1. **–ú–æ–Ω—ñ—Ç–æ—Ä–∏—Ç–∏ –≤ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤—ñ** 1-2 —Ç–∏–∂–Ω—ñ
2. **–ó–±–∏—Ä–∞—Ç–∏ –º–µ—Ç—Ä–∏–∫–∏** –Ω–∞ 429 –ø–æ–º–∏–ª–∫–∞—Ö —ñ —á–∞—Å—É –æ–±—Ä–æ–±–∫–∏
3. **–ù–∞—Å—Ç—Ä–æ—ó—Ç–∏** `TAG_SPACE_AI_CONCURRENCY` –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
4. **–†–æ–∑–≥–ª—è–Ω—É—Ç–∏** –ø–æ—Å—Ç—ñ–π–Ω–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ (Redis) –¥–ª—è –ø–æ–¥–∞–ª—å—à–æ—ó –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó

---

## –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –π –í–∏—Ä—ñ—à–µ–Ω–Ω—è –ü—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: –©–µ –æ—Ç—Ä–∏–º—É—é –ø–æ–º–∏–ª–∫–∏ 429

**–†—ñ—à–µ–Ω–Ω—è:**
```env
# –ó–º–µ–Ω—à–∏—Ç–∏ –æ–¥–Ω–æ—á–∞—Å–Ω—ñ—Å—Ç—å –¥–∞–ª—ñ
TAG_SPACE_AI_CONCURRENCY=2
TAG_SPACE_MAX_AI_CONCURRENCY=5
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ß–∞—Å –æ–±—Ä–æ–±–∫–∏ –∑—Ä—ñ—Å

**–†—ñ—à–µ–Ω–Ω—è:**
```env
# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ä–æ–∑–º—ñ—Ä –≥—Ä—É–ø–∏ —Ç–∞ –æ–¥–Ω–æ—á–∞—Å–Ω—ñ—Å—Ç—å
TAG_SPACE_BATCH_SIZE=10
TAG_SPACE_AI_CONCURRENCY=5
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ó–±—ñ–ª—å—à–∏–ª–∞—Å—è –ø–∞–º'—è—Ç—å

**–†—ñ—à–µ–Ω–Ω—è:**
```env
# –ó–º–µ–Ω—à–∏—Ç–∏ —Ä–æ–∑–º—ñ—Ä –∫–µ—à–∞
TAG_SPACE_CACHE_SIZE=500
TAG_SPACE_BATCH_SIZE=3
```

---

**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤–æ –¥–æ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó! üöÄ
