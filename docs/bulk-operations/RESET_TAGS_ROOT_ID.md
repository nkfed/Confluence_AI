# Reset Tags –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é `root_id` (Tree Scope)

## üìã –û–≥–ª—è–¥

–ï–Ω–¥–ø–æ—ñ–Ω—Ç `POST /bulk/reset-tags/{space_key}` —Ç–µ–ø–µ—Ä –ø—ñ–¥—Ç—Ä–∏–º—É—î –ø–∞—Ä–∞–º–µ—Ç—Ä `root_id`, —è–∫–∏–π –¥–æ–∑–≤–æ–ª—è—î –≤–∏–¥–∞–ª—è—Ç–∏ —Ç–µ–≥–∏ –ª–∏—à–µ –≤ –º–µ–∂–∞—Ö –¥–µ—Ä–µ–≤–∞ —Å—Ç–æ—Ä—ñ–Ω–æ–∫, —â–æ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ –≤–∫–∞–∑–∞–Ω–æ–≥–æ `page_id`.

## üîß API –°–ø–µ—Ü–∏—Ñ—ñ–∫–∞—Ü—ñ—è

### Endpoint
```
POST /bulk/reset-tags/{space_key}
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä–∏

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –û–±–æ–≤'—è–∑–∫–æ–≤–∏–π | –û–ø–∏—Å |
|----------|-----|--------------|------|
| `space_key` | string (path) | ‚úÖ –¢–∞–∫ | –ö–ª—é—á Confluence –ø—Ä–æ—Å—Ç–æ—Ä—É |
| `categories` | string (query) | ‚ùå –ù—ñ | –ö–∞—Ç–µ–≥–æ—Ä—ñ—ó —Ç–µ–≥—ñ–≤ –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è (comma-separated: `doc,domain,kb,tool`). –Ø–∫—â–æ –Ω–µ –≤–∫–∞–∑–∞–Ω–æ ‚Äî –≤–∏–¥–∞–ª—è—é—Ç—å—Å—è –≤—Å—ñ AI-—Ç–µ–≥–∏ |
| `dry_run` | boolean (query) | ‚ùå –ù—ñ | Dry-run —Ä–µ–∂–∏–º (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º `true`) |
| `root_id` | string (query) | ‚ùå –ù—ñ | ID –∫–æ—Ä–µ–Ω–µ–≤–æ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏. –Ø–∫—â–æ –≤–∫–∞–∑–∞–Ω–æ ‚Äî –æ–±—Ä–æ–±–ª—è—é—Ç—å—Å—è –ª–∏—à–µ –Ω–∞—â–∞–¥–∫–∏ —Ü—ñ—î—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏ |

### –ü—Ä–∏–∫–ª–∞–¥–∏ –∑–∞–ø–∏—Ç—ñ–≤

#### 1. –í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ AI-—Ç–µ–≥–∏ —É –≤—Å—å–æ–º—É –ø—Ä–æ—Å—Ç–æ—Ä—ñ (space scope)
```bash
POST /bulk/reset-tags/MYSPACE?dry_run=false
```

#### 2. –í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ AI-—Ç–µ–≥–∏ –≤ –¥–µ—Ä–µ–≤—ñ —Å—Ç–æ—Ä—ñ–Ω–æ–∫ (tree scope)
```bash
POST /bulk/reset-tags/MYSPACE?root_id=123456&dry_run=false
```

#### 3. –í–∏–¥–∞–ª–∏—Ç–∏ —Ç–µ–≥–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ–π `doc` —Ç–∞ `kb` –≤ –¥–µ—Ä–µ–≤—ñ
```bash
POST /bulk/reset-tags/MYSPACE?root_id=123456&categories=doc,kb&dry_run=false
```

#### 4. Dry-run –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º)
```bash
POST /bulk/reset-tags/MYSPACE?root_id=123456
```

## üì§ –§–æ—Ä–º–∞—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ

```json
{
  "total": 10,
  "processed": 10,
  "removed": 8,
  "no_tags": 2,
  "errors": 0,
  "dry_run": true,
  "scope": "tree",
  "root_id": "123456",
  "details": [
    {
      "page_id": "123456",
      "title": "Root Page",
      "status": "dry_run",
      "removed_tags": ["doc-api", "kb-guide"],
      "skipped": false
    },
    {
      "page_id": "123457",
      "title": "Child Page",
      "status": "no_tags",
      "removed_tags": [],
      "skipped": false
    }
  ]
}
```

### –ü–æ–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å |
|------|-----|------|
| `total` | int | –ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Å—Ç–æ—Ä—ñ–Ω–æ–∫ –¥–ª—è –æ–±—Ä–æ–±–∫–∏ |
| `processed` | int | –ö—ñ–ª—å–∫—ñ—Å—Ç—å –æ–±—Ä–æ–±–ª–µ–Ω–∏—Ö —Å—Ç–æ—Ä—ñ–Ω–æ–∫ |
| `removed` | int | –ö—ñ–ª—å–∫—ñ—Å—Ç—å —Å—Ç–æ—Ä—ñ–Ω–æ–∫ –∑ –≤–∏–¥–∞–ª–µ–Ω–∏–º–∏ —Ç–µ–≥–∞–º–∏ |
| `no_tags` | int | –ö—ñ–ª—å–∫—ñ—Å—Ç—å —Å—Ç–æ—Ä—ñ–Ω–æ–∫ –±–µ–∑ AI-—Ç–µ–≥—ñ–≤ |
| `errors` | int | –ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–º–∏–ª–æ–∫ |
| `dry_run` | boolean | –ß–∏ –±—É–≤ —Ü–µ dry-run —Ä–µ–∂–∏–º |
| `scope` | string | `"space"` –∞–±–æ `"tree"` |
| `root_id` | string\|null | ID –∫–æ—Ä–µ–Ω–µ–≤–æ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏ (—è–∫—â–æ –≤–∫–∞–∑–∞–Ω–æ) |
| `details` | array | –î–µ—Ç–∞–ª—ñ –ø–æ –∫–æ–∂–Ω—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ |

### –°—Ç–∞—Ç—É—Å–∏ —Å—Ç–æ—Ä—ñ–Ω–æ–∫

- `"removed"` ‚Äî —Ç–µ–≥–∏ –±—É–ª–∏ –≤–∏–¥–∞–ª–µ–Ω—ñ
- `"dry_run"` ‚Äî —Ç–µ–≥–∏ –±—É–ª–∏ –± –≤–∏–¥–∞–ª–µ–Ω—ñ (dry-run —Ä–µ–∂–∏–º)
- `"no_tags"` ‚Äî –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –Ω–µ–º–∞—î AI-—Ç–µ–≥—ñ–≤
- `"error"` ‚Äî –≤–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–±—Ä–æ–±—Ü—ñ

## ‚ö†Ô∏è –í–∞–ª—ñ–¥–∞—Ü—ñ—è

### 1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ `root_id` –¥–æ `space_key`

–Ø–∫—â–æ `root_id` –≤–∫–∞–∑–∞–Ω–æ, —Å–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–≤—ñ—Ä—è—î, —â–æ —Ü—è —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –Ω–∞–ª–µ–∂–∏—Ç—å –¥–æ –≤–∫–∞–∑–∞–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç–æ—Ä—É.

**–ü–æ–º–∏–ª–∫–∞:**
```json
{
  "total": 0,
  "processed": 0,
  "removed": 0,
  "no_tags": 0,
  "errors": 1,
  "dry_run": true,
  "scope": "tree",
  "root_id": "999999",
  "error": "root_id 999999 does not belong to space MYSPACE",
  "details": []
}
```

### 2. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —ñ—Å–Ω—É–≤–∞–Ω–Ω—è `root_id`

–Ø–∫—â–æ `root_id` –Ω–µ —ñ—Å–Ω—É—î –∞–±–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π:

**–ü–æ–º–∏–ª–∫–∞:**
```json
{
  "total": 0,
  "processed": 0,
  "removed": 0,
  "no_tags": 0,
  "errors": 1,
  "dry_run": true,
  "scope": "tree",
  "root_id": "invalid_id",
  "error": "Invalid root_id: Page not found",
  "details": []
}
```

## üîÑ –õ–æ–≥—ñ–∫–∞ —Ä–æ–±–æ—Ç–∏

### Space Scope (–±–µ–∑ `root_id`)
1. –û—Ç—Ä–∏–º–∞—Ç–∏ –≤—Å—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –ø—Ä–æ—Å—Ç–æ—Ä—É —á–µ—Ä–µ–∑ `SpaceService.get_space_pages()`
2. –î–ª—è –∫–æ–∂–Ω–æ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏:
   - –û—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ—Ç–æ—á–Ω—ñ —Ç–µ–≥–∏
   - –í—ñ–¥—Ñ—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏ —Ç–µ–≥–∏ –∑–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è–º–∏ (—è–∫—â–æ –≤–∫–∞–∑–∞–Ω–æ)
   - –í–∏–¥–∞–ª–∏—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ —Ç–µ–≥–∏ (—è–∫—â–æ `dry_run=false`)

### Tree Scope (–∑ `root_id`)
1. **–í–∞–ª—ñ–¥–∞—Ü—ñ—è:** –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —â–æ `root_id` –Ω–∞–ª–µ–∂–∏—Ç—å –¥–æ `space_key`
2. **–ó–±—ñ—Ä –¥–µ—Ä–µ–≤–∞:** —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ –∑—ñ–±—Ä–∞—Ç–∏ –≤—Å—ñ ID –Ω–∞—â–∞–¥–∫—ñ–≤ —á–µ—Ä–µ–∑ `collect_tree_pages()`
3. **–û–±—Ä–æ–±–∫–∞:** –¥–ª—è –∫–æ–∂–Ω–æ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –≤ –¥–µ—Ä–µ–≤—ñ:
   - –û—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ—Ç–æ—á–Ω—ñ —Ç–µ–≥–∏
   - –í—ñ–¥—Ñ—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏ —Ç–µ–≥–∏ –∑–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è–º–∏ (—è–∫—â–æ –≤–∫–∞–∑–∞–Ω–æ)
   - –í–∏–¥–∞–ª–∏—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ —Ç–µ–≥–∏ (—è–∫—â–æ `dry_run=false`)

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç—ñ–≤
```bash
pytest tests/test_reset_tags_root_id.py -v
```

### –¢–µ—Å—Ç-–∫–µ–π—Å–∏
1. ‚úÖ Space scope –±–µ–∑ `root_id` ‚Äî –æ–±—Ä–æ–±–∫–∞ –≤—Å—å–æ–≥–æ –ø—Ä–æ—Å—Ç–æ—Ä—É
2. ‚úÖ Tree scope –∑ `root_id` ‚Äî –æ–±—Ä–æ–±–∫–∞ –ª–∏—à–µ –¥–µ—Ä–µ–≤–∞
3. ‚úÖ –ö–æ–º–±—ñ–Ω–∞—Ü—ñ—è `root_id` + `categories` ‚Äî –≤–∏–¥–∞–ª–µ–Ω–Ω—è –≤–∏–±—Ä–∞–Ω–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ–π –≤ –¥–µ—Ä–µ–≤—ñ
4. ‚úÖ –í–∞–ª—ñ–¥–∞—Ü—ñ—è `root_id` –Ω–∞–ª–µ–∂–∏—Ç—å –¥–æ —ñ–Ω—à–æ–≥–æ –ø—Ä–æ—Å—Ç–æ—Ä—É ‚Äî –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è error
5. ‚úÖ –í–∞–ª—ñ–¥–∞—Ü—ñ—è –Ω–µ–≤–∞–ª—ñ–¥–Ω–æ–≥–æ `root_id` ‚Äî –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è error
6. ‚úÖ –°–µ—Ä–≤—ñ—Å–Ω–∏–π –º–µ—Ç–æ–¥ `reset_tree_tags` ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω–∞ –æ–±—Ä–æ–±–∫–∞ —Å–ø–∏—Å–∫—É page_ids
7. ‚úÖ –°–µ—Ä–≤—ñ—Å–Ω–∏–π –º–µ—Ç–æ–¥ `collect_tree_pages` ‚Äî —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–∏–π –æ–±—Ö—ñ–¥ –¥–µ—Ä–µ–≤–∞

## üìÇ –ó–º—ñ–Ω–µ–Ω—ñ —Ñ–∞–π–ª–∏

### 1. `src/api/routers/bulk_reset_tags.py`
- –î–æ–¥–∞–Ω–æ –ø–∞—Ä–∞–º–µ—Ç—Ä `root_id: Optional[str]` –¥–æ –µ–Ω–¥–ø–æ—ñ–Ω—Ç—É
- –î–æ–¥–∞–Ω–æ –ª–æ–≥—ñ–∫—É –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó `root_id`
- –î–æ–¥–∞–Ω–æ —É–º–æ–≤–Ω—É –ª–æ–≥—ñ–∫—É –¥–ª—è space/tree scope
- –û–Ω–æ–≤–ª–µ–Ω–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∑ –ø–æ–ª—è–º–∏ `scope` —Ç–∞ `root_id`

### 2. `src/services/tag_reset_service.py`
- –î–æ–¥–∞–Ω–æ –º–µ—Ç–æ–¥ `collect_tree_pages(root_page_id: str)` ‚Äî —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–∏–π –∑–±—ñ—Ä –¥–µ—Ä–µ–≤–∞
- –î–æ–¥–∞–Ω–æ –º–µ—Ç–æ–¥ `reset_tree_tags(page_ids, categories, dry_run)` ‚Äî —Å–∫–∏–¥–∞–Ω–Ω—è —Ç–µ–≥—ñ–≤ –≤ –¥–µ—Ä–µ–≤—ñ

### 3. `tests/test_reset_tags_root_id.py`
- –°—Ç–≤–æ—Ä–µ–Ω–æ –Ω–æ–≤–∏–π —Ç–µ—Å—Ç–æ–≤–∏–π —Ñ–∞–π–ª –∑ 8 —Ç–µ—Å—Ç-–∫–µ–π—Å–∞–º–∏

## üîó –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ —ñ—Å–Ω—É—é—á–æ—é —Å–∏—Å—Ç–µ–º–æ—é

–ù–æ–≤–∞ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å —É–∑–≥–æ–¥–∂–µ–Ω–∞ –∑ —ñ—Å–Ω—É—é—á–æ—é –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–æ—é:

- **–õ–æ–≥—ñ–∫–∞ –æ–±—Ö–æ–¥—É –¥–µ—Ä–µ–≤–∞:** –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —Ç–æ–π —Å–∞–º–∏–π –ø—ñ–¥—Ö—ñ–¥, —â–æ –π `tag-tree` (`_collect_all_children`)
- **–í–∞–ª—ñ–¥–∞—Ü—ñ—è:** –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –¥–æ –ø—Ä–æ—Å—Ç–æ—Ä—É (–∞–Ω–∞–ª–æ–≥—ñ—á–Ω–æ `tag-tree`)
- **–§–æ—Ä–º–∞—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ:** —Ä–æ–∑—à–∏—Ä–µ–Ω–æ —ñ—Å–Ω—É—é—á–∏–π —Ñ–æ—Ä–º–∞—Ç, –¥–æ–¥–∞–Ω–æ `scope` —Ç–∞ `root_id`
- **Dry-run:** –ø–æ–≤–Ω—ñ—Å—Ç—é –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –ø–æ—Ç–æ—á–Ω–∞ –ø–æ–≤–µ–¥—ñ–Ω–∫–∞

## üí° –ü—Ä–∏–∫–ª–∞–¥–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

### Use Case 1: –û—á–∏—Å—Ç–∏—Ç–∏ —Ç–µ–≥–∏ –≤ –º–µ–∂–∞—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó —Ä–æ–∑–¥—ñ–ª—É
```bash
# Dry-run —Å–ø–æ—á–∞—Ç–∫—É
POST /bulk/reset-tags/DOCS?root_id=98765&dry_run=true

# –ü—ñ—Å–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ ‚Äî –≤–∏–∫–æ–Ω–∞—Ç–∏
POST /bulk/reset-tags/DOCS?root_id=98765&dry_run=false
```

### Use Case 2: –í–∏–¥–∞–ª–∏—Ç–∏ –ª–∏—à–µ `doc-*` —Ç–µ–≥–∏ –≤ –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª—ñ
```bash
POST /bulk/reset-tags/KB?root_id=12345&categories=doc&dry_run=false
```

### Use Case 3: –ü–æ–≤–Ω–µ –æ—á–∏—â–µ–Ω–Ω—è –≤—Å—å–æ–≥–æ –ø—Ä–æ—Å—Ç–æ—Ä—É
```bash
POST /bulk/reset-tags/ARCHIVE?dry_run=false
```

## üöÄ –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏

–ú–æ–∂–ª–∏–≤—ñ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è:
- [ ] Whitelist integration (—Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è –∑–∞ –¥–æ–∑–≤–æ–ª–µ–Ω–∏–º–∏ —Å—Ç–æ—Ä—ñ–Ω–∫–∞–º–∏)
- [ ] Batch processing (–æ–±—Ä–æ–±–∫–∞ –≤–µ–ª–∏–∫–∏—Ö –¥–µ—Ä–µ–≤ –ø–∞–∫–µ—Ç–∞–º–∏)
- [ ] Progress tracking (–ø—Ä–æ–≥—Ä–µ—Å –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏—Ö –∑–∞–¥–∞—á)
- [ ] Undo mechanism (–º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –≤—ñ–¥–∫–æ—Ç–∏—Ç–∏ –∑–º—ñ–Ω–∏)

---

**–í–µ—Ä—Å—ñ—è:** 1.0  
**–î–∞—Ç–∞:** 2025-12-30  
**–ê–≤—Ç–æ—Ä:** VS Code Agent
